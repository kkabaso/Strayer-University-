(function(t){var e,o=function(e){VST.trigger("user:signout",t.parseJSON(e.responseText))},i=3e3,n=6e4,a=200,r=function(t,e){this.threshold=t||i,this.flushInterval=e||n,this.clear()};r.prototype.clear=function(){this.logs=[]},r.prototype.current=function(){return 0===this.logs.length?null:this.logs[this.logs.length-1]},r.prototype.incrementDuration=function(t){null==t&&(t=1e3);var e=this.current();if(e)return e.duration+=t,e.duration},r.prototype.add=function(t){var e=this.current();t.duration=t.duration||0,e&&e.page===t.page?this.incrementDuration(t.duration):this.logs.push(t)};r.prototype.flush=function(e,i){null==i&&(i=!0);for(var n=[],a=this.current(),r=0;r<this.logs.length;r++)this.logs[r].duration>=this.threshold&&(this.logs[r].duration=Math.round(this.logs[r].duration/1e3),n.push(this.logs[r]));this.clear(),VST.pageViewFlags&&VST.pageViewFlags[VST.Book.getFormat()]&&n.length>0&&t.ajax({url:VST.Book.buildAPIURL("/logs"),type:"POST",data:{logs:n},dataType:"json",async:i,statusCode:{401:o}}),e||(a&&this.add({page:a.page}),this.flushLater())},r.prototype.flushSyncAndStop=function(){this.flush(!0,!1)},r.prototype.flushLater=function(t){null==t&&(t=this.flushInterval),clearTimeout(this.flushTimeout);var e=this;this.flushTimeout=setTimeout(function(){e.flush()},t)};var s,u,l,g=function(t,e){e&&(e.cfi&&(l=e.cfi),e.page&&(VST.Utils.triggerPageScroll(),VST.fire("book:pagebreak",e.page)))};VST.bind("page:scroll",function(t,e){var o=e.cfi;VST.Book.getCurrentPage(function(t,e){if(e){o=o?e.getCFI()+"!"+o:e.getCFI();var i=VST.Book.pageForCFI(o,e.getCFI());i&&(s=u,u=i.label||i.title,s!==u&&VST.fire("book:pagebreak",u,s))}})});var h;VST.bind("page:ready",function(t,o){h=new r(VST.pageViewDuration,VST.pageViewFlushInterval),g(t,o),clearInterval(e),e=setInterval(function(){h.incrementDuration(a)},a),h.flushLater()}),VST.bind("book:pagebreak",function(t,e){h&&h.add({page:e})}),VST.bind("page:load",function(){g()}),VST.bind("page:unload",function(){h.flush(!0)}),this.BatchedPageViewLogger=r,VST.BatchedPageViewLogger=h}).call(this,VST.$);